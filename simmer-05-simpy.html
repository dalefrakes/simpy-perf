<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Iñaki Ucar" />

<meta name="date" content="2020-07-13" />

<title>Other SimPy Examples</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' || rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Other SimPy Examples</h1>
<h4 class="author"><em>Iñaki Ucar</em></h4>
<h4 class="date"><em>2020-07-13</em></h4>


<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#carwash">Carwash</a></li>
<li><a href="#machine-shop">Machine Shop</a></li>
<li><a href="#movie-renege">Movie Renege</a></li>
<li><a href="#gas-station-refuelling">Gas Station Refuelling</a></li>
</ul>
</div>

<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>These examples are adapted from the Python package ‘SimPy’, <a href="https://simpy.readthedocs.io/en/latest/examples">here</a>. Users familiar with SimPy may find these examples helpful for transitioning to <code>simmer</code>. Some very basic material is not covered. Beginners should first read <em><a href="simmer-04-bank-1.html">The Bank Tutorial: Part I</a> &amp; <a href="simmer-04-bank-2.html">Part II</a></em>.</p>
</div>
<div id="carwash" class="section level2">
<h2>Carwash</h2>
<p>Covers:</p>
<ul>
<li>Standard resources.</li>
<li>Waiting for other processes.</li>
<li>Logging messages into the console.</li>
</ul>
<p>From <a href="https://simpy.readthedocs.io/en/latest/examples/carwash.html">here</a>:</p>
<blockquote>
<p>A carwash has a limited number of washing machines and defines a washing process that takes some time. Cars arrive at the carwash at a random time. If one washing machine is available, they start the washing process and wait for it to finish. If not, they wait until they an use one.</p>
</blockquote>
<p>Parameters and setup:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

NUM_MACHINES &lt;-<span class="st"> </span><span class="dv">2</span>  <span class="co"># Number of machines in the carwash</span>
WASHTIME &lt;-<span class="st"> </span><span class="dv">5</span>      <span class="co"># Minutes it takes to clean a car</span>
T_INTER &lt;-<span class="st"> </span><span class="dv">7</span>       <span class="co"># Create a car every ~7 minutes</span>
SIM_TIME &lt;-<span class="st"> </span><span class="dv">20</span>     <span class="co"># Simulation time in minutes</span>

<span class="co"># setup</span>
<span class="kw">set.seed</span>(<span class="dv">42</span>)
env &lt;-<span class="st"> </span><span class="kw">simmer</span>()</code></pre></div>
<p>The implementation with <code>simmer</code> is as simple as defining the trajectory each arriving <code>car</code> will share and follow. This trajectory comprises seizing a wash machine, spending some time and releasing it. The process takes <code>WASHTIME</code> and removes some random percentage of dirt between 50 and 90%. The <code>log_()</code> messages are merely illustrative.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">car &lt;-<span class="st"> </span><span class="kw">trajectory</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">log_</span>(<span class="st">&quot;arrives at the carwash&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">seize</span>(<span class="st">&quot;wash&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">log_</span>(<span class="st">&quot;enters the carwash&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">timeout</span>(WASHTIME) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">set_attribute</span>(<span class="st">&quot;dirt_removed&quot;</span>, <span class="cf">function</span>() <span class="kw">sample</span>(<span class="dv">50</span><span class="op">:</span><span class="dv">99</span>, <span class="dv">1</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">log_</span>(<span class="cf">function</span>() 
    <span class="kw">paste0</span>(<span class="kw">get_attribute</span>(env, <span class="st">&quot;dirt_removed&quot;</span>), <span class="st">&quot;% of dirt was removed&quot;</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">release</span>(<span class="st">&quot;wash&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">log_</span>(<span class="st">&quot;leaves the carwash&quot;</span>)</code></pre></div>
<p>Finally, we setup the resources and feed the trajectory with a couple of generators. The result is shown below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">env <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_resource</span>(<span class="st">&quot;wash&quot;</span>, NUM_MACHINES) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># feed the trajectory with 4 initial cars</span>
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;car_initial&quot;</span>, car, <span class="kw">at</span>(<span class="kw">rep</span>(<span class="dv">0</span>, <span class="dv">4</span>))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># new cars approx. every T_INTER minutes</span>
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;car&quot;</span>, car, <span class="cf">function</span>() <span class="kw">sample</span>((T_INTER<span class="op">-</span><span class="dv">2</span>)<span class="op">:</span>(T_INTER<span class="op">+</span><span class="dv">2</span>), <span class="dv">1</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># start the simulation</span>
<span class="st">  </span><span class="kw">run</span>(SIM_TIME)
<span class="co">#&gt; 0: car_initial0: arrives at the carwash</span>
<span class="co">#&gt; 0: car_initial0: enters the carwash</span>
<span class="co">#&gt; 0: car_initial1: arrives at the carwash</span>
<span class="co">#&gt; 0: car_initial1: enters the carwash</span>
<span class="co">#&gt; 0: car_initial2: arrives at the carwash</span>
<span class="co">#&gt; 0: car_initial3: arrives at the carwash</span>
<span class="co">#&gt; 5: car_initial0: 96% of dirt was removed</span>
<span class="co">#&gt; 5: car_initial1: 64% of dirt was removed</span>
<span class="co">#&gt; 5: car_initial0: leaves the carwash</span>
<span class="co">#&gt; 5: car_initial1: leaves the carwash</span>
<span class="co">#&gt; 5: car_initial2: enters the carwash</span>
<span class="co">#&gt; 5: car_initial3: enters the carwash</span>
<span class="co">#&gt; 9: car0: arrives at the carwash</span>
<span class="co">#&gt; 10: car_initial2: 82% of dirt was removed</span>
<span class="co">#&gt; 10: car_initial3: 75% of dirt was removed</span>
<span class="co">#&gt; 10: car_initial2: leaves the carwash</span>
<span class="co">#&gt; 10: car_initial3: leaves the carwash</span>
<span class="co">#&gt; 10: car0: enters the carwash</span>
<span class="co">#&gt; 15: car0: 86% of dirt was removed</span>
<span class="co">#&gt; 15: car0: leaves the carwash</span>
<span class="co">#&gt; 18: car1: arrives at the carwash</span>
<span class="co">#&gt; 18: car1: enters the carwash</span>
<span class="co">#&gt; simmer environment: anonymous | now: 20 | next: 23</span>
<span class="co">#&gt; { Monitor: in memory }</span>
<span class="co">#&gt; { Resource: wash | monitored: TRUE | server status: 1(2) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Source: car_initial | monitored: 1 | n_generated: 4 }</span>
<span class="co">#&gt; { Source: car | monitored: 1 | n_generated: 3 }</span></code></pre></div>
</div>
<div id="machine-shop" class="section level2">
<h2>Machine Shop</h2>
<p>Covers:</p>
<ul>
<li>Preemptive resources.</li>
<li>Interruptions.</li>
<li>Loops.</li>
<li>Attributes.</li>
</ul>
<p>From <a href="https://simpy.readthedocs.io/en/latest/examples/machine_shop.html">here</a>:</p>
<blockquote>
<p>This example comprises a workshop with <code>n</code> identical machines. A stream of jobs (enough to keep the machines busy) arrives. Each machine breaks down periodically. Repairs are carried out by one repairman. The repairman has other, less important tasks to perform, too. Broken machines preempt theses tasks. The repairman continues them when he is done with the machine repair. The workshop works continuously.</p>
</blockquote>
<p>First of all, we load the libraries and prepare the environment.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

PT_MEAN &lt;-<span class="st"> </span><span class="fl">10.0</span>         <span class="co"># Avg. processing time in minutes</span>
PT_SIGMA &lt;-<span class="st"> </span><span class="fl">2.0</span>         <span class="co"># Sigma of processing time</span>
MTTF &lt;-<span class="st"> </span><span class="fl">300.0</span>           <span class="co"># Mean time to failure in minutes</span>
BREAK_MEAN &lt;-<span class="st"> </span><span class="dv">1</span> <span class="op">/</span><span class="st"> </span>MTTF  <span class="co"># Param. for exponential distribution</span>
REPAIR_TIME &lt;-<span class="st"> </span><span class="fl">30.0</span>     <span class="co"># Time it takes to repair a machine in minutes</span>
JOB_DURATION &lt;-<span class="st"> </span><span class="fl">30.0</span>    <span class="co"># Duration of other jobs in minutes</span>
NUM_MACHINES &lt;-<span class="st"> </span><span class="dv">10</span>      <span class="co"># Number of machines in the machine shop</span>
WEEKS &lt;-<span class="st"> </span><span class="dv">4</span>              <span class="co"># Simulation time in weeks</span>
SIM_TIME &lt;-<span class="st"> </span>WEEKS <span class="op">*</span><span class="st"> </span><span class="dv">7</span> <span class="op">*</span><span class="st"> </span><span class="dv">24</span> <span class="op">*</span><span class="st"> </span><span class="dv">60</span>  <span class="co"># Simulation time in minutes</span>

<span class="co"># setup</span>
<span class="kw">set.seed</span>(<span class="dv">42</span>)
env &lt;-<span class="st"> </span><span class="kw">simmer</span>()</code></pre></div>
<p>The <code>make_parts</code> trajectory defines a machine’s operating loop. A worker seizes the machine and starts manufacturing and counting parts in an infinite loop. Provided we want more than one machine, we parametrise the trajectory as a function of the machine:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">make_parts &lt;-<span class="st"> </span><span class="cf">function</span>(machine)
  <span class="kw">trajectory</span>() <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">seize</span>(machine, <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">timeout</span>(<span class="cf">function</span>() <span class="kw">rnorm</span>(<span class="dv">1</span>, PT_MEAN, PT_SIGMA)) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">set_attribute</span>(<span class="st">&quot;parts&quot;</span>, <span class="dv">1</span>, <span class="dt">mod=</span><span class="st">&quot;+&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">    </span><span class="kw">rollback</span>(<span class="dv">2</span>, <span class="ot">Inf</span>) <span class="co"># go to 'timeout' over and over</span></code></pre></div>
<p>Repairman’s <em>unimportant</em> jobs may be modelled in the same way (without the accounting part):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">other_jobs &lt;-<span class="st"> </span><span class="kw">trajectory</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">seize</span>(<span class="st">&quot;repairman&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">timeout</span>(JOB_DURATION) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rollback</span>(<span class="dv">1</span>, <span class="ot">Inf</span>)</code></pre></div>
<p>Failures are high-priority arrivals, both for the machines and for the repairman. Each random generated failure will randomly select and seize (break) a machine, and will seize (call) the repairman. After the machine is repaired, both resources are released and the corresponding workers begin where they left.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">machines &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">&quot;machine&quot;</span>, <span class="dv">1</span><span class="op">:</span>NUM_MACHINES<span class="op">-</span><span class="dv">1</span>)

failure &lt;-<span class="st"> </span><span class="kw">trajectory</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(machines, <span class="dt">policy =</span> <span class="st">&quot;random&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">seize_selected</span>(<span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">seize</span>(<span class="st">&quot;repairman&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">timeout</span>(REPAIR_TIME) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">release</span>(<span class="st">&quot;repairman&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">release_selected</span>(<span class="dv">1</span>)</code></pre></div>
<p>The machines and their workers are appended to the simulation environment. Note that each machine, which is defined as preemptive, has space for one worker (or a failure) and no space in queue.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">for</span> (i <span class="cf">in</span> machines) env <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_resource</span>(i, <span class="dv">1</span>, <span class="dv">0</span>, <span class="dt">preemptive =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_generator</span>(<span class="kw">paste0</span>(i, <span class="st">&quot;_worker&quot;</span>), <span class="kw">make_parts</span>(i), <span class="kw">at</span>(<span class="dv">0</span>), <span class="dt">mon =</span> <span class="dv">2</span>)</code></pre></div>
<p>The same for the repairman, but this time the queue is infinite, since there could be any number of machines at any time waiting for repairments.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">env <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_resource</span>(<span class="st">&quot;repairman&quot;</span>, <span class="dv">1</span>, <span class="ot">Inf</span>, <span class="dt">preemptive =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;repairman_worker&quot;</span>, other_jobs, <span class="kw">at</span>(<span class="dv">0</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span>invisible</code></pre></div>
<p>Finally, the failure generator is defined with <code>priority=1</code> (default: 0), and the simulation begins:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">env <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;failure&quot;</span>, failure, 
                <span class="cf">function</span>() <span class="kw">rexp</span>(<span class="dv">1</span>, BREAK_MEAN <span class="op">*</span><span class="st"> </span>NUM_MACHINES), 
                <span class="dt">priority =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">run</span>(SIM_TIME) <span class="op">%&gt;%</span><span class="st"> </span>invisible</code></pre></div>
<p>The last value per worker from the attributes table reports the number of parts made:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">aggregate</span>(value <span class="op">~</span><span class="st"> </span>name, <span class="kw">get_mon_attributes</span>(env), max)
<span class="co">#&gt;                name value</span>
<span class="co">#&gt; 1  machine0_worker0  3250</span>
<span class="co">#&gt; 2  machine1_worker0  3303</span>
<span class="co">#&gt; 3  machine2_worker0  3241</span>
<span class="co">#&gt; 4  machine3_worker0  3336</span>
<span class="co">#&gt; 5  machine4_worker0  3399</span>
<span class="co">#&gt; 6  machine5_worker0  3423</span>
<span class="co">#&gt; 7  machine6_worker0  3304</span>
<span class="co">#&gt; 8  machine7_worker0  3181</span>
<span class="co">#&gt; 9  machine8_worker0  3253</span>
<span class="co">#&gt; 10 machine9_worker0  3169</span></code></pre></div>
</div>
<div id="movie-renege" class="section level2">
<h2>Movie Renege</h2>
<p>Covers:</p>
<ul>
<li>Standard resources.</li>
<li>Condition events.</li>
<li>Shared events.</li>
<li>Attributes.</li>
</ul>
<p>From <a href="https://simpy.readthedocs.io/en/latest/examples/movie_renege.html">here</a>:</p>
<blockquote>
<p>This example models a movie theater with one ticket counter selling tickets for three movies (next show only). People arrive at random times and try to buy a random number (1-6) of tickets for a random movie. When a movie is sold out, all people waiting to buy a ticket for that movie renege (leave the queue).</p>
</blockquote>
<p>First of all, we load the libraries and prepare the environment.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

TICKETS &lt;-<span class="st"> </span><span class="dv">50</span>     <span class="co"># Number of tickets per movie</span>
SIM_TIME &lt;-<span class="st"> </span><span class="dv">120</span>   <span class="co"># Simulate until</span>
movies &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;R Unchained&quot;</span>, <span class="st">&quot;Kill Process&quot;</span>, <span class="st">&quot;Pulp Implementation&quot;</span>)

<span class="co"># setup</span>
<span class="kw">set.seed</span>(<span class="dv">42</span>)
env &lt;-<span class="st"> </span><span class="kw">simmer</span>()</code></pre></div>
<p>The main actor of this simulation is the <em>moviegoer</em>, a process that will try to buy a number of tickets for a certain movie. The logic is as follows:</p>
<ol style="list-style-type: decimal">
<li><strong>Select</strong> a movie and go to the theater.</li>
<li>At any moment, the <em>moviegoer</em> <strong>reneges if</strong> the movie becomes sold out (the “sold out” event is received).</li>
<li>In particular, <strong>leave</strong> immediately if the movie already became sold out.</li>
<li>Reach the ticket counter and stay in the queue. When the turn comes (counter is <strong>seized</strong>),
<ol style="list-style-type: decimal">
<li>Try to buy (<strong>seize</strong> the resource) tickets (randomly chosen between 1 and 6).
<ul>
<li>If there are not enough tickets, the <em>moviegoer</em> is <strong>rejected</strong> after some discussion.</li>
</ul></li>
<li>Provided the <em>moviegoer</em> has tickets, the reneging condition is <strong>aborted</strong>.</li>
<li>Check the tickets available and, if at most one ticket is left…
<ul>
<li><strong>Set</strong> instant rejection for future customers (at point 3.).</li>
<li><strong>Send</strong> the “sold out” event (subscribed at point 2.) for current customers (waiting at point 4.).</li>
</ul></li>
</ol></li>
<li><strong>Release</strong> the ticket counter after the duration of the purchase.</li>
<li>Enjoy the movie!</li>
</ol>
<p>This recipe is directly translated into a <code>simmer</code> trajectory as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">get_movie &lt;-<span class="st"> </span><span class="cf">function</span>() movies[<span class="kw">get_attribute</span>(env, <span class="st">&quot;movie&quot;</span>)]
soldout_signal &lt;-<span class="st"> </span><span class="cf">function</span>() <span class="kw">paste0</span>(<span class="kw">get_movie</span>(), <span class="st">&quot; sold out&quot;</span>)
check_soldout &lt;-<span class="st"> </span><span class="cf">function</span>() <span class="kw">get_capacity</span>(env, <span class="kw">get_movie</span>()) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>
check_tickets_available &lt;-<span class="st"> </span><span class="cf">function</span>()
  <span class="kw">get_server_count</span>(env, <span class="kw">get_movie</span>()) <span class="op">&gt;</span><span class="st"> </span>(TICKETS <span class="op">-</span><span class="st"> </span><span class="dv">2</span>)

moviegoer &lt;-<span class="st"> </span><span class="kw">trajectory</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># select a movie</span>
<span class="st">  </span><span class="kw">set_attribute</span>(<span class="st">&quot;movie&quot;</span>, <span class="cf">function</span>() <span class="kw">sample</span>(<span class="dv">3</span>, <span class="dv">1</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">select</span>(get_movie) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># set reneging condition</span>
<span class="st">  </span><span class="kw">renege_if</span>(soldout_signal) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># leave immediately if the movie was already sold out</span>
<span class="st">  </span><span class="kw">leave</span>(check_soldout) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># wait for my turn</span>
<span class="st">  </span><span class="kw">seize</span>(<span class="st">&quot;counter&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># buy tickets</span>
<span class="st">  </span><span class="kw">seize_selected</span>(
    <span class="cf">function</span>() <span class="kw">sample</span>(<span class="dv">6</span>, <span class="dv">1</span>), <span class="dt">continue =</span> <span class="ot">FALSE</span>,
    <span class="dt">reject =</span> <span class="kw">trajectory</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">timeout</span>(<span class="fl">0.5</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">release</span>(<span class="st">&quot;counter&quot;</span>, <span class="dv">1</span>)
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># abort reneging condition</span>
<span class="st">  </span><span class="kw">renege_abort</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># check the tickets available</span>
<span class="st">  </span><span class="kw">branch</span>(
    check_tickets_available, <span class="dt">continue =</span> <span class="ot">TRUE</span>,
    <span class="kw">trajectory</span>() <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">set_capacity_selected</span>(<span class="dv">0</span>) <span class="op">%&gt;%</span>
<span class="st">      </span><span class="kw">send</span>(soldout_signal)
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">timeout</span>(<span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">release</span>(<span class="st">&quot;counter&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># watch the movie</span>
<span class="st">  </span><span class="kw">wait</span>()</code></pre></div>
<p>which actually constitutes a quite interesting subset of <code>simmer</code>’s capabilities. The next step is to add the required resources to the environment <code>env</code>: the three movies and the ticket counter.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># add movies as resources with capacity TICKETS and no queue</span>
<span class="cf">for</span> (i <span class="cf">in</span> movies) env <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_resource</span>(i, TICKETS, <span class="dv">0</span>)

<span class="co"># add ticket counter with capacity 1 and infinite queue</span>
env <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">add_resource</span>(<span class="st">&quot;counter&quot;</span>, <span class="dv">1</span>, <span class="ot">Inf</span>)
<span class="co">#&gt; simmer environment: anonymous | now: 0 | next: </span>
<span class="co">#&gt; { Monitor: in memory }</span>
<span class="co">#&gt; { Resource: R Unchained | monitored: TRUE | server status: 0(50) | queue status: 0(0) }</span>
<span class="co">#&gt; { Resource: Kill Process | monitored: TRUE | server status: 0(50) | queue status: 0(0) }</span>
<span class="co">#&gt; { Resource: Pulp Implementation | monitored: TRUE | server status: 0(50) | queue status: 0(0) }</span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span></code></pre></div>
<p>And finally, we attach an exponential <em>moviegoer</em> generator to the <code>moviegoer</code> trajectory and the simulation starts:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># add a moviegoer generator and start simulation</span>
env <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;moviegoer&quot;</span>, moviegoer, <span class="cf">function</span>() <span class="kw">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="fl">0.5</span>), <span class="dt">mon=</span><span class="dv">2</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">run</span>(SIM_TIME)
<span class="co">#&gt; simmer environment: anonymous | now: 120 | next: 120.719252450748</span>
<span class="co">#&gt; { Monitor: in memory }</span>
<span class="co">#&gt; { Resource: R Unchained | monitored: TRUE | server status: 49(0) | queue status: 0(0) }</span>
<span class="co">#&gt; { Resource: Kill Process | monitored: TRUE | server status: 50(0) | queue status: 0(0) }</span>
<span class="co">#&gt; { Resource: Pulp Implementation | monitored: TRUE | server status: 50(0) | queue status: 0(0) }</span>
<span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Source: moviegoer | monitored: 2 | n_generated: 230 }</span></code></pre></div>
<p>The analysis is performed with standard R tools:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># get the three rows with the sold out instants</span>
sold_time &lt;-<span class="st"> </span><span class="kw">get_mon_resources</span>(env) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">subset</span>(resource <span class="op">!=</span><span class="st"> &quot;counter&quot;</span> <span class="op">&amp;</span><span class="st"> </span>capacity <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)

<span class="co"># get the arrivals that left at the sold out instants</span>
<span class="co"># count the number of arrivals per movie</span>
n_reneges &lt;-<span class="st"> </span><span class="kw">get_mon_arrivals</span>(env) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">subset</span>(finished <span class="op">==</span><span class="st"> </span><span class="ot">FALSE</span> <span class="op">&amp;</span><span class="st"> </span>end_time <span class="op">%in%</span><span class="st"> </span>sold_time<span class="op">$</span>time) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">merge</span>(<span class="kw">get_mon_attributes</span>(env)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">transform</span>(<span class="dt">resource =</span> movies[value]) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">aggregate</span>(value <span class="op">~</span><span class="st"> </span>resource, <span class="dt">data=</span>., length)

<span class="co"># merge the info  and print</span>
<span class="kw">invisible</span>(<span class="kw">apply</span>(<span class="kw">merge</span>(sold_time, n_reneges), <span class="dv">1</span>, <span class="cf">function</span>(i) {
  <span class="kw">cat</span>(<span class="st">&quot;Movie '&quot;</span>, i[<span class="st">&quot;resource&quot;</span>], <span class="st">&quot;' was sold out in &quot;</span>, i[<span class="st">&quot;time&quot;</span>], <span class="st">&quot; minutes.</span><span class="ch">\n</span><span class="st">&quot;</span>, 
      <span class="st">&quot;  Number of people that left the queue: &quot;</span>, i[<span class="st">&quot;value&quot;</span>], <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>, <span class="dt">sep=</span><span class="st">&quot;&quot;</span>)
}))
<span class="co">#&gt; Movie 'Kill Process' was sold out in 34.09917 minutes.</span>
<span class="co">#&gt;   Number of people that left the queue:  8</span>
<span class="co">#&gt; Movie 'Pulp Implementation' was sold out in 33.09917 minutes.</span>
<span class="co">#&gt;   Number of people that left the queue:  5</span>
<span class="co">#&gt; Movie 'R Unchained' was sold out in 38.09917 minutes.</span>
<span class="co">#&gt;   Number of people that left the queue: 11</span></code></pre></div>
</div>
<div id="gas-station-refuelling" class="section level2">
<h2>Gas Station Refuelling</h2>
<p>Covers:</p>
<ul>
<li>Standard resources.</li>
<li>Waiting for other processes.</li>
<li>Condition events.</li>
<li>Shared events.</li>
<li>Concatenating trajectories.</li>
<li>Loops.</li>
<li>Logging messages into the console.</li>
</ul>
<p>From <a href="https://simpy.readthedocs.io/en/latest/examples/gas_station_refuel.html">here</a>:</p>
<blockquote>
<p>This example models a gas station and cars that arrive for refuelling. The gas station has a limited number of fuel pumps and a fuel tank that is shared between the fuel pumps.</p>
<p>Vehicles arriving at the gas station first request a fuel pump from the station. Once they acquire one, they try to take the desired amount of fuel from the fuel pump. They leave when they are done.</p>
<p>The fuel level is reqularly monitored by a controller. When the level drops below a certain threshold, a tank truck is called for refilling the tank.</p>
</blockquote>
<p>Parameters and setup:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(simmer)

GAS_STATION_SIZE &lt;-<span class="st"> </span><span class="dv">200</span>     <span class="co"># liters</span>
THRESHOLD &lt;-<span class="st"> </span><span class="dv">10</span>             <span class="co"># Threshold for calling the tank truck (in %)</span>
FUEL_TANK_SIZE &lt;-<span class="st"> </span><span class="dv">50</span>        <span class="co"># liters</span>
FUEL_TANK_LEVEL &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">25</span>) <span class="co"># Min/max levels of fuel tanks (in liters)</span>
REFUELING_SPEED &lt;-<span class="st"> </span><span class="dv">2</span>        <span class="co"># liters / second</span>
TANK_TRUCK_TIME &lt;-<span class="st"> </span><span class="dv">300</span>      <span class="co"># Seconds it takes the tank truck to arrive</span>
T_INTER &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">30</span>, <span class="dv">100</span>)       <span class="co"># Create a car every [min, max] seconds</span>
SIM_TIME &lt;-<span class="st"> </span><span class="dv">1000</span>            <span class="co"># Simulation time in seconds</span>

<span class="co"># setup</span>
<span class="kw">set.seed</span>(<span class="dv">42</span>)
env &lt;-<span class="st"> </span><span class="kw">simmer</span>()</code></pre></div>
<p>SimPy solves this problem using a special kind of resource called <em>container</em>, which is not present in <code>simmer</code> so far. However, a container is nothing more than an embellished counter. Therefore, we can implement this in <code>simmer</code> with a global counter (<code>GAS_STATION_LEVEL</code> here), some signaling and some care checking the counter bounds.</p>
<p>Let us consider just the refuelling process in the first place. A car needs to check whether there is enough fuel available to fill its tank. If not, it needs to block until the gas station is refilled.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">GAS_STATION_LEVEL &lt;-<span class="st"> </span>GAS_STATION_SIZE
signal &lt;-<span class="st"> &quot;gas station refilled&quot;</span>

refuelling &lt;-<span class="st"> </span><span class="kw">trajectory</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># check if there is enough fuel available</span>
<span class="st">  </span><span class="kw">branch</span>(<span class="cf">function</span>() FUEL_TANK_SIZE <span class="op">-</span><span class="st"> </span><span class="kw">get_attribute</span>(env, <span class="st">&quot;level&quot;</span>) <span class="op">&gt;</span><span class="st"> </span>GAS_STATION_LEVEL, 
         <span class="dt">continue =</span> <span class="ot">TRUE</span>,
         <span class="co"># if not, block until the signal &quot;gas station refilled&quot; is received</span>
         <span class="kw">trajectory</span>() <span class="op">%&gt;%</span>
<span class="st">           </span><span class="kw">trap</span>(signal) <span class="op">%&gt;%</span>
<span class="st">           </span><span class="kw">wait</span>() <span class="op">%&gt;%</span>
<span class="st">           </span><span class="kw">untrap</span>(signal)
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># refuel</span>
<span class="st">  </span><span class="kw">timeout</span>(<span class="cf">function</span>() {
    liters_required &lt;-<span class="st"> </span>FUEL_TANK_SIZE <span class="op">-</span><span class="st"> </span><span class="kw">get_attribute</span>(env, <span class="st">&quot;level&quot;</span>)
    GAS_STATION_LEVEL &lt;&lt;-<span class="st"> </span>GAS_STATION_LEVEL <span class="op">-</span><span class="st"> </span>liters_required
    <span class="kw">return</span>(liters_required <span class="op">/</span><span class="st"> </span>REFUELING_SPEED)
  })</code></pre></div>
<p>Now a car’s trajectory is straightforward. First, the starting time is saved as well as the tank level. Then, the car seizes a pump, refuels and leaves.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">car &lt;-<span class="st"> </span><span class="kw">trajectory</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">set_attribute</span>(<span class="kw">c</span>(<span class="st">&quot;start&quot;</span>, <span class="st">&quot;level&quot;</span>), <span class="cf">function</span>() 
    <span class="kw">c</span>(<span class="kw">now</span>(env), <span class="kw">sample</span>(FUEL_TANK_LEVEL[<span class="dv">1</span>]<span class="op">:</span>FUEL_TANK_LEVEL[<span class="dv">2</span>], <span class="dv">1</span>))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">log_</span>(<span class="st">&quot;arriving at gas station&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">seize</span>(<span class="st">&quot;pump&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="co"># 'join()' concatenates the refuelling trajectory here</span>
<span class="st">  </span><span class="kw">join</span>(refuelling) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">release</span>(<span class="st">&quot;pump&quot;</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">log_</span>(<span class="cf">function</span>() 
    <span class="kw">paste0</span>(<span class="st">&quot;finished refuelling in &quot;</span>, <span class="kw">now</span>(env) <span class="op">-</span><span class="st"> </span><span class="kw">get_attribute</span>(env, <span class="st">&quot;start&quot;</span>), <span class="st">&quot; seconds&quot;</span>))</code></pre></div>
<p>The tank truck takes some time to arrive. Then, the gas station is completely refilled and the signal “gas station refilled” is sent to the blocked cars.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tank_truck &lt;-<span class="st"> </span><span class="kw">trajectory</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">timeout</span>(TANK_TRUCK_TIME) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">log_</span>(<span class="st">&quot;tank truck arriving at gas station&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">log_</span>(<span class="cf">function</span>() {
    refill &lt;-<span class="st"> </span>GAS_STATION_SIZE <span class="op">-</span><span class="st"> </span>GAS_STATION_LEVEL
    GAS_STATION_LEVEL &lt;&lt;-<span class="st"> </span>GAS_STATION_SIZE
    <span class="kw">paste0</span>(<span class="st">&quot;tank truck refilling &quot;</span>, refill, <span class="st">&quot; liters&quot;</span>)
  }) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">send</span>(signal)</code></pre></div>
<p>The controller periodically checks the <code>GAS_STATION_LEVEL</code> and calls the tank truck when needed.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">controller &lt;-<span class="st"> </span><span class="kw">trajectory</span>() <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">branch</span>(<span class="cf">function</span>() GAS_STATION_LEVEL <span class="op">/</span><span class="st"> </span>GAS_STATION_SIZE <span class="op">*</span><span class="st"> </span><span class="dv">100</span> <span class="op">&lt;</span><span class="st"> </span>THRESHOLD, 
         <span class="dt">continue =</span> <span class="ot">TRUE</span>,
         <span class="kw">trajectory</span>() <span class="op">%&gt;%</span>
<span class="st">           </span><span class="kw">log_</span>(<span class="st">&quot;calling the tank truck&quot;</span>) <span class="op">%&gt;%</span>
<span class="st">           </span><span class="kw">join</span>(tank_truck)
  ) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">timeout</span>(<span class="dv">10</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">rollback</span>(<span class="dv">2</span>, <span class="ot">Inf</span>)</code></pre></div>
<p>Finally, we need to add a couple of pumps, a controller worker and a car generator.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">env <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_resource</span>(<span class="st">&quot;pump&quot;</span>, <span class="dv">2</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;controller&quot;</span>, controller, <span class="kw">at</span>(<span class="dv">0</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">add_generator</span>(<span class="st">&quot;car&quot;</span>, car, <span class="cf">function</span>() <span class="kw">sample</span>(T_INTER[<span class="dv">1</span>]<span class="op">:</span>T_INTER[<span class="dv">2</span>], <span class="dv">1</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw">run</span>(SIM_TIME)
<span class="co">#&gt; 94: car0: arriving at gas station</span>
<span class="co">#&gt; 107: car0: finished refuelling in 13 seconds</span>
<span class="co">#&gt; 144: car1: arriving at gas station</span>
<span class="co">#&gt; 158: car1: finished refuelling in 14 seconds</span>
<span class="co">#&gt; 219: car2: arriving at gas station</span>
<span class="co">#&gt; 236.5: car2: finished refuelling in 17.5 seconds</span>
<span class="co">#&gt; 301: car3: arriving at gas station</span>
<span class="co">#&gt; 322.5: car3: finished refuelling in 21.5 seconds</span>
<span class="co">#&gt; 377: car4: arriving at gas station</span>
<span class="co">#&gt; 392.5: car4: finished refuelling in 15.5 seconds</span>
<span class="co">#&gt; 439: car5: arriving at gas station</span>
<span class="co">#&gt; 440: controller0: calling the tank truck</span>
<span class="co">#&gt; 454: car5: finished refuelling in 15 seconds</span>
<span class="co">#&gt; 535: car6: arriving at gas station</span>
<span class="co">#&gt; 597: car7: arriving at gas station</span>
<span class="co">#&gt; 696: car8: arriving at gas station</span>
<span class="co">#&gt; 740: controller0: tank truck arriving at gas station</span>
<span class="co">#&gt; 740: controller0: tank truck refilling 193 liters</span>
<span class="co">#&gt; 753: car7: finished refuelling in 156 seconds</span>
<span class="co">#&gt; 759: car9: arriving at gas station</span>
<span class="co">#&gt; 760: car6: finished refuelling in 225 seconds</span>
<span class="co">#&gt; 774.5: car8: finished refuelling in 78.5 seconds</span>
<span class="co">#&gt; 777: car9: finished refuelling in 18 seconds</span>
<span class="co">#&gt; 853: car10: arriving at gas station</span>
<span class="co">#&gt; 860: controller0: calling the tank truck</span>
<span class="co">#&gt; 874.5: car10: finished refuelling in 21.5 seconds</span>
<span class="co">#&gt; 953: car11: arriving at gas station</span>
<span class="co">#&gt; 988: car12: arriving at gas station</span>
<span class="co">#&gt; simmer environment: anonymous | now: 1000 | next: 1045</span>
<span class="co">#&gt; { Monitor: in memory }</span>
<span class="co">#&gt; { Resource: pump | monitored: TRUE | server status: 2(2) | queue status: 0(Inf) }</span>
<span class="co">#&gt; { Source: controller | monitored: 1 | n_generated: 1 }</span>
<span class="co">#&gt; { Source: car | monitored: 1 | n_generated: 14 }</span></code></pre></div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
